<div class="support-detail-container" *ngIf="ticket">
  <p-toast></p-toast>

  <!-- Header Section -->
  <div class="detail-header">
    <div class="header-content">
      <div class="header-left">
        <button pButton icon="pi pi-arrow-left" 
                class="p-button-text back-button" 
                (click)="goBack()"
                pTooltip="Geri Dön"
                title="Geri Dön">
        </button>
        <div class="ticket-info">
          <h1 class="ticket-title">{{ ticket.Title }}</h1>
          <div class="ticket-meta">
            <span class="ticket-id">#{{ ticket.Id }}</span>
            <span class="ticket-date">{{ ticket.CreatedAt | date:'dd MMM yyyy HH:mm' }}</span>
          </div>
        </div>
      </div>
      
      <div class="header-right">
        <div class="ticket-status">
          <!-- <p-dropdown
            [options]="statusOptions"
            [value]="ticket.status"
            (onChange)="updateStatus($event.value)"
            placeholder="Durum seçin"
            class="status-dropdown"
          ></p-dropdown> -->
        </div>
      </div>
    </div>
  </div>

  <!-- Ticket Details -->
  <div class="ticket-details">
    <div class="details-grid">
      <!-- Main Content -->
      <div class="main-content">
        <!-- Ticket Info Card -->
        <p-card class="ticket-card">
          <ng-template pTemplate="header">
            <div class="card-header">
              <div class="ticket-tags">
                <p-tag 
                  [value]="getStatusLabel(ticket.Status)" 
                  [severity]="getStatusColor(ticket.Status)"
                ></p-tag>
                <p-tag 
                  [value]="getPriorityLabel(ticket.Priority)" 
                  [severity]="getPriorityColor(ticket.Priority)"
                ></p-tag>
                <p-tag 
                  [value]="getCategoryLabel(ticket.Category)" 
                  severity="info"
                ></p-tag>
              </div>
            </div>
          </ng-template>

          <ng-template pTemplate="content">
            <div class="ticket-description">
              <h3>Talep Açıklaması</h3>
              <p>{{ ticket.Description }}</p>
            </div>

            <div class="ticket-author">
              <div class="author-info">
                <i class="pi pi-user"></i>
                <div class="author-details">
                  <span class="author-name">{{ ticket.CreatedBy }}</span>
                  <span class="author-email">{{ ticket.CreatedByEmail }}</span>
                </div>
              </div>
            </div>
          </ng-template>
        </p-card>

        <!-- Messages Section -->
        <div class="messages-section">
          <div class="section-header">
            <h3 class="section-title">
              <i class="pi pi-comments"></i>
              Mesajlar ({{ ticket.Messages?.length || 0 }})
            </h3>
            <!-- Debug button - remove in production -->
            <button *ngIf="ticket.Messages && ticket.Messages.length > 0" 
                    pButton 
                    icon="pi pi-info-circle" 
                    class="p-button-text p-button-sm debug-button"
                    (click)="debugMessage(ticket.Messages[0], 0)"
                    pTooltip="Debug Message Structure"
                    title="Debug Message Structure">
            </button>
          </div>

          <div class="messages-list" *ngIf="ticket.Messages && ticket.Messages.length > 0; else noMessages">
            <div *ngFor="let message of ticket.Messages; let i = index" 
                 class="message-item"
                 [ngClass]="{
                   'admin-message': getMessageProperty(message, 'senderType') === 'admin', 
                   'user-message': getMessageProperty(message, 'senderType') === 'user'
                 }">
              
              <div class="message-header">
                <div class="message-author">
                  <div class="author-avatar" [ngClass]="getMessageProperty(message, 'senderType') || 'user'">
                    <i class="pi" [ngClass]="getMessageProperty(message, 'senderType') === 'admin' ? 'pi-shield' : 'pi-user'"></i>
                  </div>
                  <div class="author-info">
                    <span class="author-name">{{ getMessageProperty(message, 'senderName') || 'Bilinmeyen Kullanıcı' }}</span>
                    <span class="message-time">{{ formatMessageDate(message) }}</span>
                  </div>
                </div>
                <div class="message-badge" *ngIf="getMessageProperty(message, 'isInternal')">
                  <p-tag value="İç Not" severity="warning" size="small"></p-tag>
                </div>
              </div>

              <div class="message-content">
                <p>{{ getMessageProperty(message, 'message') || 'Mesaj içeriği bulunamadı' }}</p>
              </div>
            </div>
          </div>

          <ng-template #noMessages>
            <div class="no-messages">
              <div class="no-messages-content">
                <i class="pi pi-comments no-messages-icon"></i>
                <p>Henüz mesaj bulunmuyor</p>
              </div>
            </div>
          </ng-template>
        </div>

        <!-- Response Form -->
        <div class="response-section">
          <h3 class="section-title">
            <i class="pi pi-reply"></i>
            Yanıt Yaz
          </h3>

          <form [formGroup]="responseForm" (ngSubmit)="onSubmit()" class="response-form">
            <div class="form-field">
              <label for="message" class="field-label">
                Mesajınız
                <span class="required">*</span>
              </label>
              <textarea
                id="message"
                pInputTextarea
                formControlName="message"
                [rows]="4"
                placeholder="Yanıtınızı buraya yazın..."
                [class.invalid]="isFieldInvalid('message')"
                class="form-textarea"
              ></textarea>
              <div *ngIf="getFieldError('message')" class="error-message">
                <i class="pi pi-exclamation-triangle"></i>
                {{ getFieldError('message') }}
              </div>
            </div>

            <div class="form-actions">
              <div class="form-options">
                <div class="checkbox-field">
                  <input type="checkbox" 
                         id="isInternal" 
                         formControlName="isInternal"
                         class="form-checkbox">
                  <label for="isInternal" class="checkbox-label">
                    İç not (sadece admin'ler görür)
                  </label>
                </div>
              </div>

              <div class="submit-actions">
                <p-button
                  type="submit"
                  label="Yanıt Gönder"
                  icon="pi pi-send"
                  [loading]="isSubmitting"
                  [disabled]="responseForm.invalid || isSubmitting"
                  severity="primary"
                ></p-button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Ticket Info -->
        <p-card class="info-card">
          <ng-template pTemplate="header">
            <div class="card-header">
              <h4>Ticket Bilgileri</h4>
            </div>
          </ng-template>

          <ng-template pTemplate="content">
            <div class="info-list">
              <div class="info-item">
                <span class="info-label">Durum:</span>
                <p-tag 
                  [value]="getStatusLabel(ticket.Status)" 
                  [severity]="getStatusColor(ticket.Status)"
                ></p-tag>
              </div>
              
              <div class="info-item">
                <span class="info-label">Öncelik:</span>
                <p-tag 
                  [value]="getPriorityLabel(ticket.Priority)" 
                  [severity]="getPriorityColor(ticket.Priority)"
                ></p-tag>
              </div>
              
              <div class="info-item">
                <span class="info-label">Kategori:</span>
                <span class="info-value">{{ getCategoryLabel(ticket.Category) }}</span>
              </div>
              
              <div class="info-item">
                <span class="info-label">Oluşturan:</span>
                <span class="info-value">{{ ticket.CreatedBy }}</span>
              </div>
              
              <div class="info-item">
                <span class="info-label">E-posta:</span>
                <span class="info-value">{{ ticket.CreatedByEmail }}</span>
              </div>
              
              <div class="info-item">
                <span class="info-label">Oluşturma:</span>
                <span class="info-value">{{ ticket.CreatedAt | date:'dd MMM yyyy HH:mm' }}</span>
              </div>
              
              <div class="info-item">
                <span class="info-label">Güncelleme:</span>
                <span class="info-value">{{ ticket.UpdatedAt | date:'dd MMM yyyy HH:mm' }}</span>
              </div>
            </div>
          </ng-template>
        </p-card>
      </div>
    </div>
  </div>
</div>

<div *ngIf="!ticket" class="loading-container">
  <div class="loading-content">
    <i class="pi pi-spinner pi-spin loading-icon"></i>
    <p>Ticket yükleniyor...</p>
  </div>
</div> 